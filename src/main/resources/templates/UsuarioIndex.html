<!DOCTYPE html>
<!--
Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
Click nbfs://nbhost/SystemFileSystem/Templates/Other/html.html to edit this template
-->
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="https://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{Layout}">

    <section class="container my-5" layout:fragment="content">
        <section>
            <div> 
                <form>
                    <div class="row d-flex justify-content-between m-1">
                        <div class="col-8 justify-content-start text-secondary">
                            <h3 class="h-3">Usuarios</h3>
                        </div>
                        <div class="col-auto d-flex align-items-end">
                            
<!--                            <div th:if="${errores.size() != 0}">
                                <span class="text-danger">Existen errores en tu archivo</span>
                                <ul th:each="error, iterStat: ${errores}">
                                    <li th:text="${error.descripcion}"></li>
                                </ul>
                            </div> -->
                            <div class="col-auto" th:if="${errores != null}">
                                <span class="text-success">Hay errores en tu archivo</span>
                                <span th:text="${errores}"></span>
                            </div>
                        </div>
                        <div class="col-auto d-flex align-items-end">
                            <button class="btn btn-outline-secondary"
                                    type="button" data-bs-toggle="modal" 
                                    data-bs-target="#modalBusqueda">
                                Buscar

                            </button> 
                        </div>
                        <div class="col-auto d-flex align-items-end">
                            
                            <button class="btn btn-warning"
                                    type="button" data-bs-toggle="modal" 
                                    data-bs-target="#modalCarga">
                                Cargar

                            </button> 
                        </div>
                        <div  class="col-auto d-flex align-items-end">
                            <!--<span class="">No hay errores</span>-->
                             <button type="submit" class="btn btn-success">Procesar</button>
                        </div>
                       

                    </div>

                </form>

            </div>
        </section>
        <section>
            <div class="my-3 p-3 bg-body rounded shadow-sm">
                <div class="row justify-content-end">
                    <div class="col-2 d-flex justify-content-end">
                        <a type="button" class="btn btn-success"  th:href="@{/usuario/add}">
                            <i class="bi bi-plus-lg"></i>
                            Agregar
                        </a>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class=" table table-hover table-striped">
                        <thead>
                            <tr>
                                <th scope="col" class="text-black-50">#Id</th>
                                <th scope="col-1" class="text-black-50">Imagen</th>
                                <th scope="col-1" class="text-black-50">
                                    Nombre
                                </th>
                                <th scope="col" class="text-black-50">
                                    <i class="bi bi-geo-alt-fill"></i>
                                    Direccion
                                </th>
                                <th scope="col" class="text-black-50">
                                    <i class="bi bi-telephone-fill"></i>
                                    Contacto
                                </th>
                                <th scope="col-1" class="text-black-50">Roll</th>
                                <th scope="col-1" class="text-black-50">Status</th>
                                <th scope="col" class="text-black-50">Accion</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="usuario, iterStat: ${usuarios}" >
                                <th  scope="row"><span th:text="${iterStat.index + 1}"></span></th>
                                <td class="col-1">
                                    <img th:src="${usuario.Imagen == null} ? 'https://mdbootstrap.com/img/Photos/Others/placeholder-avatar.jpg' : 'data:image/jpeg;base64,' + ${usuario.Imagen}"
                                         alt="Foto de perfil" class="rounded-circle" id="imagen" width="42">
                                </td>
                                <td class="col-1" th:text="|${usuario.Nombre} ${usuario.ApellidoPaterno}|"></td>
                                <td class="col-4">
                                    <ul th:each="direccion, iterStat: ${usuario.Direccion}">
                                        <li th:text="|Calle: ${direccion.Calle}, Numero Interior: ${direccion.NumeroInterior}, Numero Exterior: ${direccion.NumeroExterior}, Numero Exterior: ${direccion.NumeroExterior}|"></li>
                                    </ul>

                                </td>
                                <td>
                                    <ul>
                                        <li>Celular: <span th:text="${usuario.Celular}"></span></li>
                                        <li>Telefono: <span th:text="${usuario.Telefono}"></span></li>
                                        <li>Email: <span th:text="${usuario.Email}"></span></li>
                                    </ul>
                                </td>
                                <td class="">
                                    <div class="badge text-bg-secondary"><span th:text="${usuario.Roll.NombreRoll}"></span></div>
                                </td>
                                <td class="col-1">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input status-switch" 
                                               type="checkbox" 
                                               role="switch" 
                                               id="switchCheckChecked" 
                                               th:attr="data-id=${usuario.IdUsuario}"
                                               th:checked="${usuario.Status == 1}">
                                    </div>
                                </td>
                                <td class=" col-3">
                                    <a type="button" class="btn btn-primary btn-sm" th:href="@{/usuario/detail/{id}(id=${usuario.IdUsuario})}"> 
                                        <i class="bi bi-pencil-square"></i>
                                        
                                    </a>
                                    <button type="button" class="btn btn-danger btn-sm" th:onclick="|confirmarEliminacionUsuario(${usuario.IdUsuario})|"> 
                                        <i class="bi bi-trash3-fill"></i>
                                    </button>
                                </td>
                            </tr> 
                        </tbody>
                    </table>
                    
                </div>
            </div>
        </section>
        <div class="modal fade" id="modalCarga" tabindex="-1" aria-labelledby="modalCargaLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title justify-content-center" id="modalCargaLabel"> Cargar Archivo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form class="p-4 justify-content-center my-3"  th:action="@{usuario/enviar}" method="post" enctype="multipart/form-data" id="cargaForm">                 
                            <div class="row justify-content-center text-center">
                                <label  class="form-label d-block mb-2">Selecciona un archivo (.txt o .xlsx)</label>
                                <input type="file" 
                                       id="archivo" 
                                       name="archivo" 
                                       accept=".txt,.xlsx"
                                       style="display: none;" 
                                       onchange="nombreArchivo(event, this)">
                                <label for="archivo" class="btn btn-outline-secondary d-flex flex-column align-items-center p-3 shadow-sm rounded-3" style="cursor: pointer;">
                                    <i class="bi bi-cloud-arrow-up fs-3 mb-1"></i>
                                    <span>Escoger archivo</span>
                                </label>
                                <p id="nombre-archivo" class="mt-2 text-muted small"></p>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="submit" class="btn btn-primary" form="cargaForm">Subir</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="modalBusqueda" tabindex="-1" aria-labelledby="modalBusquedaLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h5 class="modal-title" id="modalBusquedaLabel">Buscar Usuario</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>

                        <div class="modal-body">

                            <form class="p-4" th:action="@{/usuario/filtro}" th:object="${Usuario}" method="post" id="filtroForm">

                                <div class="mb-3">
                                    <label class="form-label">Nombre</label>
                                    <input type="text" class="form-control" name="Nombre"
                                           placeholder="Ingrese el nombre"
                                           th:field="*{Nombre}">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Apellido Paterno</label>
                                    <input type="text" class="form-control" name="ApellidoPaterno"
                                           placeholder="Ingrese el apellido paterno"
                                           th:field="*{ApellidoPaterno}">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Apellido Materno</label>
                                    <input type="text" class="form-control" name="ApellidoMaterno"
                                           placeholder="Ingrese el apellido materno"
                                           th:field="*{ApellidoMaterno}">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Roll</label>
                                    <input type="text" class="form-control" name="Roll.NombreRoll"
                                           placeholder="Ingrese el rol"
                                           th:field="*{Roll.NombreRoll}">
                                </div>

                                <div class="mb-3">
                                    <input type="hidden" th:field="*{Status}" value="0">
                                    <label class="form-label d-block">Status</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input"
                                            type="checkbox"
                                            role="switch"
                                            id="switchStatus"
                                            th:field="*{Status}"
                                            value="1">

                                        <label class="form-check-label" for="switchStatus">
                                            Activo (1)
                                        </label>
                                    </div>
                                </div>

                            </form>

                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-primary" form="filtroForm">Buscar</button>
                        </div>

                    </div>
                </div>
            </div>

        <footer>
        </footer>
            
        <script>
            
            let url = "http://localhost:8080/";
            
            $(document).on("change", ".status-switch", function () {

                let idUsuario = $(this).data("id");
                let nuevoStatus = this.checked ? 1 : 0;

                $.ajax({
                    url: url + 'usuario/updateStatus',
                    type: 'PATCH',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        idUsuario: idUsuario,
                        status: nuevoStatus
                    }),
                    success: function (res) {
                        console.log('Status actualizado correctamente');

                        Swal.fire({
                            icon: "success",
                            title: "Estado actualizado",
                            text: res.errorMessage,
                            timer: 1500,
                            showConfirmButton: false
                        });
                    },
                    error: function (xhr) {
                        Swal.fire({
                            icon: "error",
                            title: "Error al actualizar",
                            text: "No se pudo cambiar el estado"
                        });
                    }
                });

            });
            
            function confirmarEliminacionUsuario(idUsuario){
            Swal.fire({
            title: "Estas seguro de eliminar este usuario?",
                    text: "No puedes revertir esta accion!",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Si, eliminalo"
            }).then((result) => {
            if (result.isConfirmed) {
            window.location.href = "/usuario/delete/" + idUsuario;
            }
            });
            }
            
            function nombreArchivo(event, input){
                
                
            }
        </script>


    
<!--    <script th:if="${successErrorArchivo}">
        
        alert("Entro a la funcion");
        if(${errores} != null) {
            
            alert("No trae errores");
            
            $("#spanErrores").text("El archivo es correcto").addClass("text-success");
        } else {
            
            $("#spanErrores").text("El archivo contiene errores").addClass("text-danger");
            alert("Trae errores");
        }
        
    </script>-->
    <script th:if="${successAddAll}" th:inline="javascript">
        Swal.fire({
        title: "Alert"
                draggable: true,
                text:  [[${successAddAll}]]
        });
    </script>
    <script th:if="${successErrorUsers}" th:inline="javascript">
        Swal.fire({
        title: "Alert"
                draggable: true,
                text:  [[${successMessage}]]
        });
    </script>
    <script th:if="${successMessage}" th:inline="javascript">
        Swal.fire({
        title: [[${successMessage}]],
                icon: "success",
                draggable: true
        });
    </script>
    <script th:if="${successDeleteMessage}" th:inline="javascript">
        Swal.fire({
        title: [[${successDeleteMessage}]],
                icon: "success",
                draggable: true
        });
    </script>
    </section>
</html>

